import streamlit as st
import pandas as pd

# 1. í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
st.set_page_config(
    page_title="MBTI êµ­ê°€ë³„ í†µê³„ ë¶„ì„ê¸°",
    page_icon="ğŸŒ",
    layout="wide"
)

# 2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ (ìºì‹±ì„ ì‚¬ìš©í•˜ì—¬ ì„±ëŠ¥ ìµœì í™”)
@st.cache_data
def load_data():
    # CSV íŒŒì¼ ë¡œë“œ (íŒŒì¼ ì´ë¦„ì´ ì •í™•í•´ì•¼ í•©ë‹ˆë‹¤)d
    try:
        df = pd.read_csv('countriesMBTI_16types.csv')
        return df
    except FileNotFoundError:
        st.error("ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'countriesMBTI_16types.csv' íŒŒì¼ì„ ê°™ì€ í´ë”ì— ìœ„ì¹˜ì‹œì¼œì£¼ì„¸ìš”.")
        return None

# 3. MBTI ì„¤ëª… ë”•ì…”ë„ˆë¦¬
mbti_info = {
    "ISTJ": "í˜„ì‹¤ì£¼ì˜ì (ì²­ë ´ê²°ë°±í•œ ë…¼ë¦¬ì£¼ì˜ì) - ì‚¬ì‹¤ì— ê·¼ê±°í•˜ì—¬ ì‚¬ê³ í•˜ë©° í–‰ë™í•©ë‹ˆë‹¤.",
    "ISFJ": "ìˆ˜í˜¸ì (ìš©ê°í•œ ìˆ˜í˜¸ì) - ì†Œì¤‘í•œ ì´ë“¤ì„ ì§€í‚¤ê³  í—Œì‹ í•˜ëŠ” ë°©ì–´ìì…ë‹ˆë‹¤.",
    "INFJ": "ì˜¹í˜¸ì (ì„ ì˜ì˜ ì˜¹í˜¸ì) - ì¡°ìš©í•˜ê³  ì‹ ë¹„ë¡œìš°ë©° ìƒ˜ì†ŸëŠ” ì˜ê°ìœ¼ë¡œ íƒ€ì¸ì„ ë•ìŠµë‹ˆë‹¤.",
    "INTJ": "ì „ëµê°€ (ìš©ì˜ì£¼ë„í•œ ì „ëµê°€) - ìƒìƒë ¥ì´ í’ë¶€í•˜ë©° ì² ë‘ì² ë¯¸í•œ ê³„íšì„ ì„¸ì›ë‹ˆë‹¤.",
    "ISTP": "ì¥ì¸ (ë§ŒëŠ¥ ì¬ì£¼ê¾¼) - ëŒ€ë‹´í•˜ê³  í˜„ì‹¤ì ì¸ ì„±í–¥ìœ¼ë¡œ ë„êµ¬ ì‚¬ìš©ì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.",
    "ISFP": "ëª¨í—˜ê°€ (í˜¸ê¸°ì‹¬ ë§ì€ ì˜ˆìˆ ê°€) - í•­ì‹œ ìƒˆë¡œìš´ ê²½í—˜ì„ ì¶”êµ¬í•˜ëŠ” ìœ ì—°í•˜ê³  ë§¤ë ¥ì ì¸ ì˜ˆìˆ ê°€ì…ë‹ˆë‹¤.",
    "INFP": "ì¤‘ì¬ì (ì—´ì •ì ì¸ ì¤‘ì¬ì) - ìƒëƒ¥í•˜ê³  ì´íƒ€ì ì´ë©° ë‚­ë§Œì ì¸ ì´ìƒì£¼ì˜ìì…ë‹ˆë‹¤.",
    "INTP": "ë…¼ë¦¬ìˆ ì‚¬ (ë…¼ë¦¬ì ì¸ ì‚¬ìƒ‰ê°€) - ëŠì„ì—†ì´ ìƒˆë¡œìš´ ì§€ì‹ì— ëª©ë§ë¼í•˜ëŠ” í˜ì‹ ê°€ì…ë‹ˆë‹¤.",
    "ESTP": "ì‚¬ì—…ê°€ (ëª¨í—˜ì„ ì¦ê¸°ëŠ” ì‚¬ì—…ê°€) - ì˜ë¦¬í•˜ê³  ì—ë„ˆì§€ ë„˜ì¹˜ë©° ê´€ì°°ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.",
    "ESFP": "ì—°ì˜ˆì¸ (ììœ ë¡œìš´ ì˜í˜¼ì˜ ì—°ì˜ˆì¸) - ì£¼ìœ„ì— ìˆìœ¼ë©´ ì¸ìƒì´ ì§€ë£¨í•  í‹ˆì´ ì—†ìŠµë‹ˆë‹¤.",
    "ENFP": "í™œë™ê°€ (ì¬ê¸°ë°œë„í•œ í™œë™ê°€) - ì°½ì˜ì ì´ê³  í•­ìƒ ì›ƒì„ ê±°ë¦¬ë¥¼ ì°¾ì•„ë‚´ëŠ” í™œë°œí•œ ì‚¬ëŒì…ë‹ˆë‹¤.",
    "ENTP": "ë³€ë¡ ê°€ (ëœ¨ê±°ìš´ ë…¼ìŸì„ ì¦ê¸°ëŠ” ë³€ë¡ ê°€) - ì§€ì ì¸ ë„ì „ì„ ë‘ë ¤ì›Œí•˜ì§€ ì•ŠëŠ” ë˜‘ë˜‘í•œ í˜¸ê¸°ì‹¬ ëŒ€ì¥ì…ë‹ˆë‹¤.",
    "ESTJ": "ê²½ì˜ì (ì—„ê²©í•œ ê´€ë¦¬ì) - ì‚¬ë¬¼ê³¼ ì‚¬ëŒì„ ê´€ë¦¬í•˜ëŠ” ë° ë›°ì–´ë‚œ ëŠ¥ë ¥ì„ ë³´ì…ë‹ˆë‹¤.",
    "ESFJ": "ì§‘ì •ê´€ (ì‚¬êµì ì¸ ì™¸êµê´€) - íƒ€ì¸ì„ ë•ëŠ” ë° ì—´ì„±ì ì¸ ì„¸ì‹¬í•˜ê³  ì‚¬êµì ì¸ ì‚¬ëŒì…ë‹ˆë‹¤.",
    "ENFJ": "ì„ ë„ì (ì •ì˜ë¡œìš´ ì‚¬íšŒìš´ë™ê°€) - ì²­ì¤‘ì„ ì‚¬ë¡œì¡ê³  ì˜ìš•ì„ ë¶ˆì–´ë„£ëŠ” ì¹´ë¦¬ìŠ¤ë§ˆ ë„˜ì¹˜ëŠ” ë¦¬ë”ì…ë‹ˆë‹¤.",
    "ENTJ": "í†µì†”ì (ëŒ€ë‹´í•œ í†µì†”ì) - ëŒ€ë‹´í•˜ê³  ìƒìƒë ¥ì´ í’ë¶€í•˜ë©° ê°•í•œ ì˜ì§€ì˜ ì§€ë„ìì…ë‹ˆë‹¤."
}

# 4. ë©”ì¸ ì•± ë¡œì§
def main():
    st.title("ğŸŒ ë‹¹ì‹ ì˜ MBTIëŠ” ì–´ë””ì„œ ê°€ì¥ ì¸ê¸°ê°€ ë§ì„ê¹Œìš”?")
    st.markdown("---")

    df = load_data()

    if df is not None:
        # ì‚¬ì´ë“œë°” í˜¹ì€ ë©”ì¸ ìƒë‹¨ì— ì„ íƒì§€ ë°°ì¹˜
        st.subheader("1ï¸âƒ£ ë‹¹ì‹ ì˜ MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”")
        
        # ì„ íƒì§€ ë¦¬ìŠ¤íŠ¸ ìƒì„± (ì²« ë²ˆì§¸ ì˜µì…˜ì€ ë¹„ì›Œë‘ê¸° ìœ„í•¨)
        mbti_options = ["ì„ íƒí•´ì£¼ì„¸ìš”"] + list(mbti_info.keys())
        
        # selectbox ìƒì„±
        selected_mbti = st.selectbox("MBTI ìœ í˜•", mbti_options)

        # ì¡°ê±´ë¶€ ë Œë”ë§: MBTIê°€ ì„ íƒë˜ì§€ ì•Šì•˜ì„ ë•Œ
        if selected_mbti == "ì„ íƒí•´ì£¼ì„¸ìš”":
            st.info("ğŸ‘† ìœ„ ë°•ìŠ¤ì—ì„œ ìì‹ ì˜ MBTI ìœ í˜•ì„ ì„ íƒí•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!")
            st.stop() # ì—¬ê¸°ì„œ ì½”ë“œ ì‹¤í–‰ ì¤‘ë‹¨ (ì•„ë˜ ë‚´ìš© ì•ˆ ë³´ì—¬ì¤Œ)

        # ì¡°ê±´ë¶€ ë Œë”ë§: MBTIê°€ ì„ íƒë˜ì—ˆì„ ë•Œ
        else:
            # 4-1. MBTI ì„¤ëª… ë³´ì—¬ì£¼ê¸°
            st.success(f"### ë‹¹ì‹ ì€ **{selected_mbti}** ì…ë‹ˆë‹¤!")
            st.write(f"> {mbti_info[selected_mbti]}")
            
            st.markdown("---")
            st.subheader(f"2ï¸âƒ£ {selected_mbti} ë¹„ìœ¨ì´ ë†’ì€ ë‚˜ë¼ Top 5")

            # 4-2. í†µê³„ ì •ë³´ ì²˜ë¦¬
            # í•´ë‹¹ MBTI ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ì—¬ ìƒìœ„ 5ê°œêµ­ ì¶”ì¶œ
            try:
                top_countries = df[['Country', selected_mbti]].sort_values(by=selected_mbti, ascending=False).head(5)
                
                # ë°ì´í„° ê°€ë…ì„±ì„ ìœ„í•´ í¼ì„¼íŠ¸ë¡œ ë³€í™˜ (0.05 -> 5.0%)
                top_countries['Percentage'] = top_countries[selected_mbti].apply(lambda x: x * 100)
                
                # ì»¬ëŸ¼ 2ê°œë¡œ ë‚˜ëˆ„ì–´ ë°°ì¹˜ (ì™¼ìª½: ì°¨íŠ¸, ì˜¤ë¥¸ìª½: ë©˜íŠ¸ ë° 1ìœ„ êµ­ê°€)
                col1, col2 = st.columns([2, 1])
                
                with col1:
                    # ë§‰ëŒ€ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (Streamlit ë‚´ì¥ ì°¨íŠ¸)
                    st.bar_chart(top_countries.set_index('Country')['Percentage'])
                    st.caption("ë‹¨ìœ„: ì „ì²´ ì¸êµ¬ ëŒ€ë¹„ ë¹„ìœ¨(%)")

                with col2:
                    # 1ìœ„ êµ­ê°€ ì •ë³´ ì¶”ì¶œ
                    number_one_country = top_countries.iloc[0]
                    country_name = number_one_country['Country']
                    ratio = number_one_country['Percentage']

                    st.metric(label="ğŸ¥‡ 1ìœ„ êµ­ê°€", value=country_name, delta=f"{ratio:.2f}%")
                    
                    # 4-3. ë§ì¶¤í˜• ë©˜íŠ¸ ìƒì„±
                    st.markdown(f"""
                    **{selected_mbti}** ìœ í˜•ì€ ì „ ì„¸ê³„ì ìœ¼ë¡œ **{country_name}**ì—ì„œ ê°€ì¥ ë¹„ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤!
                    
                    í˜¹ì‹œ ì—¬í–‰ì„ ê³„íš ì¤‘ì´ì‹ ê°€ìš”? 
                    ë¹„ìŠ·í•œ ì„±í–¥ì˜ ì‚¬ëŒë“¤ì´ ë§ì€ **{country_name}**(ìœ¼)ë¡œ ë– ë‚˜ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”? âœˆï¸
                    """)
                
                # ì „ì²´ ë°ì´í„° ë³´ê¸° (ì˜µì…˜)
                with st.expander("ğŸ“Š ì „ì²´ í†µê³„ ë°ì´í„° ë³´ê¸°"):
                    st.dataframe(df[['Country', selected_mbti]].sort_values(by=selected_mbti, ascending=False))

            except KeyError:
                st.error("ë°ì´í„° íŒŒì¼ì—ì„œ í•´ë‹¹ MBTI ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    main()
